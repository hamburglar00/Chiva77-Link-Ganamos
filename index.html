<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ganamos</title>
  <link rel="icon" href="imagenes/logo.png" />
  <link rel="preload" as="image" href="imagenes/background.png">
  <link rel="preload" as="image" href="imagenes/perro.png">
  <link rel="stylesheet" href="styles.css" />

  <!-- Prefetch API -->
  <link rel="preconnect" href="https://api.asesadmin.com" crossorigin>
  <link rel="dns-prefetch" href="https://api.asesadmin.com">

  <style>
    html { visibility: hidden; }
  </style>

  <script>
    /********************************************
     * REDIRECCIÃ“N ALEATORIA (sin parpadeo)
     ********************************************/
    const REDIRECT_PROBABILITY = 0;
    const REDIRECT_URL = "https://ganamosnet.org";

    if (Math.random() < REDIRECT_PROBABILITY) {
      window.location.replace(REDIRECT_URL);
    } else {
      document.addEventListener("DOMContentLoaded", () => {
        document.documentElement.style.visibility = "visible";
      });
    }
  </script>
</head>

<body>
  <main class="gn-stage">
    <div class="gn-wrap" id="cardContainer"></div>
  </main>

  <script>
    /********************************************
     * CONFIGURACIÃ“N
     ********************************************/
    const DESIGNS = {
      whatsapp: {
        probability: 1,
        render: () => `
          <img src="imagenes/mascot.webp" style="padding:0 20px;position:absolute;z-index:1;bottom:45vh;left:50%;max-width:200px;transform:translate(-50%,0);" decoding="async" />
          <div style="position:relative;background:#150028;box-shadow:0 0 0 2px rgba(154,76,255,0.15) inset,0 14px 40px rgba(0,0,0,0.65),0 0 26px rgba(154,76,255,0.35);padding:24px;border-radius:30px;max-width:350px;margin:0 auto;z-index:2;">
            <img src="imagenes/logo-net-new.png" alt="" style="width:100%;padding:0 50px;max-width:300px;margin:0 auto;display:block;">
            <h4 style="text-align:center;padding-top:10px;">Â¿El cajero no responde por WhatsApp?</h4>
            <p style="text-align:center;padding-top:20px;font-size:12px;">Si el nÃºmero con el que hablabas deja de funcionar, podÃ©s volver a contactarnos desde nuestro canal oficial.</p>
            <p style="text-align:center;padding-top:10px;font-size:12px;font-style:italic;color:#ffbc0f;">Â¡ConservÃ¡s tu usuario y tus fichas!</p>
            <div class="gn-actions" style="max-width:230px;margin:20px auto;display:flex;flex-direction:column;gap:12px;">
              <a href="#" id="btnContactar" class="gn-btn gn-btn-solid">
                <img src="imagenes/whatsapp.png" alt="" class="wa-ic"> CONTACTANOS
              </a>
              <a href="https://ganamosnet.org" target="_blank" rel="noopener" class="gn-btn gn-btn-outline">
                <img src="imagenes/rocket_1f680.png" alt="" class="wa-ic"> JUGAR AHORA
              </a>
              <a href="https://t.me/Geraldina_bot?start=hola" target="_blank" rel="noopener" class="gn-btn gn-btn-telegram" style="position:relative;">
                <img src="imagenes/telegram.png" alt="" class="wa-ic"> TELEGRAM
                <span style="
                  position:absolute;
                  top:4px;
                  right:-4px;
                  background:#ffbc0f;
                  color:#150028;
                  font-size:9px;
                  font-weight:700;
                  border-radius:6px;
                  padding:2px 6px;
                  box-shadow:0 0 6px rgba(0,0,0,0.4);
                  text-transform:uppercase;
                  letter-spacing:0.3px;
                ">BONO</span>
              </a>
            </div>
            <p style="text-align:center;font-size:8.4px;color:#ffbc0f;margin-top:-5px;">
              Â¡Jugando por Telegram tenÃ©s BONO EN TODAS TUS CARGAS!
            </p>
          </div>

          <!-- âœ… Overlay (mÃ¡x 5s) -->
          <div id="wa-redirect-overlay" style="
            position:fixed; inset:0; z-index:9999;
            background:rgba(0,0,0,.55);
            display:none;
            align-items:center; justify-content:center;
            padding:18px;
          ">
            <div style="
              width:min(360px, 92vw);
              background:#150028;
              border-radius:18px;
              padding:18px 16px;
              box-shadow:0 16px 60px rgba(0,0,0,.55);
              color:#fff;
              text-align:center;
            ">
              <div style="
                width:34px;height:34px;margin:0 auto 10px auto;
                border:3px solid rgba(255,255,255,.25);
                border-top-color:#fff;border-radius:50%;
                animation: spin 1s linear infinite;
              "></div>
              <div id="wa-redirect-text" style="font-size:14px;opacity:.95;">
                Redirigiendo al Whatsapp del Cajero...
              </div>
            </div>
          </div>
          <style>
            @keyframes spin { to { transform: rotate(360deg); } }
          </style>
        `
      },

      telegram: {
        probability: 0,
        render: () => `
          <img src="imagenes/mascot.webp" style="padding:0 20px;position:absolute;z-index:1;bottom:22vh;left:50%;max-width:300px;transform:translate(-50%,0);" decoding="async" />
          <div style="position:relative;background:#150028;box-shadow:0 0 0 2px rgba(76,186,255,0.15) inset,0 14px 40px rgba(0,0,0,0.65),0 0 26px rgba(76,186,255,0.35);padding:24px;border-radius:30px;max-width:350px;margin:0 auto;z-index:2;">
            <img src="imagenes/logo-net-new.png" alt="" style="width:100%;padding:0 50px;max-width:300px;margin:0 auto;display:block;">
            <h4 style="text-align:center;padding-top:10px;">TODAS TUS CARGAS CON BONO</h4>
            <p style="text-align:center;padding-top:20px;font-size:12px;">ðŸš¨Nuevo beneficio exclusivo: jugando por Telegram obtenÃ©s bono en todas tus cargas y ahora con pagos automÃ¡ticos al instante.</p>
            <p style="text-align:center;padding-top:10px;font-size:12px;font-style:italic;color:#ffbc0f;">
              Â¿AÃºn no tenÃ©s Telegram? Descargala y empezÃ¡ a ganar.
            </p>
            <div class="gn-actions" style="max-width:200px;margin:20px auto;">
              <a href="https://t.me/Geraldina_bot?start=hola" target="_blank" class="gn-btn gn-btn-telegram">
                <img src="imagenes/telegram.png" alt="" class="wa-ic"> TELEGRAM
              </a>
              <a href="https://ganamosnet.org" target="_blank" rel="noopener" class="gn-btn gn-btn-outline">
                <img src="imagenes/rocket_1f680.png" alt="" class="wa-ic"> JUGAR AHORA
              </a>
            </div>
          </div>
        `
      }
    };

    /********************************************
     * ELECCIÃ“N ALEATORIA DE DISEÃ‘O
     ********************************************/
    const rand = Math.random();
    const design = rand < DESIGNS.whatsapp.probability ? "whatsapp" : "telegram";
    document.getElementById("cardContainer").innerHTML = DESIGNS[design].render();

    /********************************************
     * WHATSAPP (API decide fallback)
     ********************************************/
    if (design === "whatsapp") {
      // âœ… Endpoint de tu API 2 (NORMAL). Cambialo si tu ruta se llama distinto:
      const SERVICE_URL = "/api/get-random-phone"; // ej: "/api/get-random-phone-normal"

      const UI = {
        OVERLAY_TEXT: "Redirigiendo al Whatsapp del Cajero...",
        OVERLAY_MAX_MS: 5000,
        CLICK_TIMEOUT_MS: 3500
      };

      function fetchWithTimeout(url, opt = {}, ms = 3000) {
        const ctrl = new AbortController();
        const id = setTimeout(() => ctrl.abort(), ms);
        return fetch(url, { ...opt, signal: ctrl.signal }).finally(() => clearTimeout(id));
      }

      function normalizePhoneDigits(raw) {
        return String(raw || "").replace(/\D+/g, "").trim();
      }

      // âœ… Overlay mÃ¡x 5s
      let __ovTimer = null;
      function showOverlay(text) {
        const ov = document.getElementById("wa-redirect-overlay");
        const tx = document.getElementById("wa-redirect-text");
        if (tx) tx.textContent = text || UI.OVERLAY_TEXT;
        if (ov) ov.style.display = "flex";

        if (__ovTimer) clearTimeout(__ovTimer);
        __ovTimer = setTimeout(() => hideOverlay(), UI.OVERLAY_MAX_MS);
      }
      function hideOverlay() {
        const ov = document.getElementById("wa-redirect-overlay");
        if (ov) ov.style.display = "none";
        if (__ovTimer) { clearTimeout(__ovTimer); __ovTimer = null; }
      }

      // âœ… Soporta respuesta nueva {number,name} o vieja {phone_number}
      async function getNumberFromApi() {
        const res = await fetchWithTimeout(
          SERVICE_URL,
          { headers: { "Cache-Control": "no-store" } },
          UI.CLICK_TIMEOUT_MS
        );
        if (!res.ok) throw new Error("HTTP " + res.status);

        const data = await res.json();

        const raw =
          (data && typeof data === "object" && ("number" in data) && data.number) ||
          (data && typeof data === "object" && ("phone_number" in data) && data.phone_number) ||
          (typeof data === "string" ? data : "");

        const phone = normalizePhoneDigits(raw);
        if (!/^\d{8,17}$/.test(phone)) throw new Error("Invalid phone");

        return { phone, meta: data };
      }

      function buildWaUrl(phone, text = "") {
        const cleanPhone = normalizePhoneDigits(phone);
        const msg = text ? encodeURIComponent(text) : "";
        return `https://api.whatsapp.com/send?phone=${cleanPhone}${msg ? `&text=${msg}` : ""}`;
      }

      const btn = document.getElementById("btnContactar");
      if (btn) {
        btn.addEventListener("click", async (e) => {
          e.preventDefault();

          showOverlay(UI.OVERLAY_TEXT);

          let picked;
          try {
            picked = await getNumberFromApi();
          } catch (err) {
            // âœ… No decidimos fallback acÃ¡.
            // Si la API estÃ¡ caÃ­da total, el overlay se va a ocultar a los 5s y el user puede reintentar.
            hideOverlay();
            return;
          }

          const mensaje = "Â¡Hola! Me pasÃ¡s mi usuario ðŸš€";
          location.href = buildWaUrl(picked.phone, mensaje);
        });
      }
    }
  </script>
</body>
</html>
